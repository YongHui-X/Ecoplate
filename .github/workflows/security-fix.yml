name: Security Auto-Fix

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      fix_python:
        description: 'Fix Python dependencies'
        type: boolean
        default: true
      fix_js:
        description: 'Fix JavaScript dependencies'
        type: boolean
        default: true

  # Run weekly on Sunday
  schedule:
    - cron: '0 0 * * 0'

jobs:
  fix-python-deps:
    name: Fix Python Dependencies
    if: ${{ github.event_name == 'schedule' || inputs.fix_python }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install tools
        run: pip install pip-audit

      - name: Check for vulnerabilities
        id: audit
        run: |
          echo "=== Current Vulnerabilities ==="
          pip-audit -r recommendation-engine/requirements.txt || true

      - name: Auto-fix vulnerabilities
        run: |
          pip-audit -r recommendation-engine/requirements.txt --fix || true
          cat recommendation-engine/requirements.txt

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(deps): auto-fix Python security vulnerabilities"
          title: "Security: Auto-fix Python Dependencies"
          body: |
            ## Automated Security Fix

            This PR was automatically generated to fix security vulnerabilities in Python dependencies.

            ### Changes
            - Updated vulnerable packages to secure versions

            ### Verification
            - [ ] Tests pass
            - [ ] Application works correctly

            ---
            Generated by Security Auto-Fix workflow
          branch: security/fix-python-deps
          labels: |
            security
            dependencies
            automated

  fix-js-deps:
    name: Fix JavaScript Dependencies
    if: ${{ github.event_name == 'schedule' || inputs.fix_js }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check for vulnerabilities
        run: |
          cd ${{ matrix.directory }}
          echo "=== Current Vulnerabilities (${{ matrix.directory }}) ==="
          npm install --package-lock-only 2>/dev/null || true
          npm audit || true

      - name: Auto-fix vulnerabilities
        run: |
          cd ${{ matrix.directory }}
          npm install --package-lock-only 2>/dev/null || true
          npm audit fix || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(deps): auto-fix ${{ matrix.directory }} security vulnerabilities"
          title: "Security: Auto-fix ${{ matrix.directory }} Dependencies"
          body: |
            ## Automated Security Fix

            This PR was automatically generated to fix security vulnerabilities in ${{ matrix.directory }} dependencies.

            ### Changes
            - Updated vulnerable packages to secure versions

            ### Verification
            - [ ] Tests pass
            - [ ] Application works correctly

            ---
            Generated by Security Auto-Fix workflow
          branch: security/fix-${{ matrix.directory }}-deps
          labels: |
            security
            dependencies
            automated
